name: Deploy Node.js Backend to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # sanity check: agar yahi step fail ho gaya to deploy hi mat kar
      - name: âœ… Install deps locally just to verify
        run: |
          npm install --legacy-peer-deps

      - name: ğŸ“¦ Create Release Archive
        run: |
          tar \
            --exclude='./storage' \
            --exclude='./node_modules' \
            --exclude='./.git' \
            --exclude='.DS_Store' \
            --exclude='./uploads' \
            --exclude='./.env' \
            -czvf backend.tar.gz . || true

      - name: ğŸš€ Upload Archive to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "backend.tar.gz"
          target: "/home/api.pvclasses.in/"

      - name: ğŸ” SSH Deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ“‚ cd into live project dir"
            cd /home/api.pvclasses.in/public_html/PvClasses_Backend

            echo "ğŸ” Backup .env if present"
            if [ -f .env ]; then
              cp .env /home/api.pvclasses.in/.env_backup_pvclasses
            fi

            echo "ğŸ›¡ï¸ Taking full snapshot backup"
            timestamp=$(date +%Y%m%d_%H%M%S)
            mkdir -p /home/api.pvclasses.in/deploy_backups
            cp -r /home/api.pvclasses.in/public_html/PvClasses_Backend /home/api.pvclasses.in/deploy_backups/PvClasses_Backend_$timestamp || true

            echo "ğŸ§¼ Cleaning old code (but keeping node_modules, uploads, .env)"
            find . -mindepth 1 -maxdepth 1 \
              ! -name 'node_modules' \
              ! -name 'uploads' \
              ! -name '.env' \
              -exec rm -rf {} +

            echo "ğŸ“¦ Extracting new backend.tar.gz here"
            tar -xzvf /home/api.pvclasses.in/backend.tar.gz -C .
            rm /home/api.pvclasses.in/backend.tar.gz

            echo "â™» Restoring .env if backed up"
            if [ -f /home/api.pvclasses.in/.env_backup_pvclasses ]; then
              mv /home/api.pvclasses.in/.env_backup_pvclasses .env
            fi

            echo "ğŸ“¦ Installing production deps"
            npm install --legacy-peer-deps --production

            echo "ğŸš€ Restarting PM2 service"
            pm2 restart api.pvclasses.in || pm2 start Index.js --name api.pvclasses.in

            echo "ğŸ’¾ Saving PM2 boot config"
            pm2 save

            echo "âœ… Deployment finished on EC2"
